name: Release Please
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *' # runs daily at midnight UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  release-please:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # The release-please action creates the git tag when a release PR is merged.
      # This tag automatically triggers the release.yml workflow (on tags matching 'v*.*.*').

  upload-cli-binaries:
    name: Upload CLI binaries to release
    if: ${{ needs.release-please.outputs.release_created }}
    needs: [release-please]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Wait for release workflow to complete
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"
          echo "Waiting for release workflow to complete for tag: $TAG_NAME"

          max_attempts=60  # Wait up to 30 minutes (60 * 30s)
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            echo "Checking for release workflow run... (attempt $((attempt + 1))/$max_attempts)"

            WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[] | select(.name == "Release") | .id')

            if [ -n "$WORKFLOW_ID" ]; then
              COMPLETED_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs" \
                --jq "[.workflow_runs[] | select(.head_sha == \"$(git rev-parse $TAG_NAME)\") | select(.status == \"completed\")] | length")

              if [ "$COMPLETED_RUNS" -gt 0 ]; then
                echo "Release workflow completed!"
                break
              fi
            fi

            echo "Release workflow still running, waiting 30 seconds..."
            sleep 30
            attempt=$((attempt + 1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "Timeout waiting for release workflow to complete"
            exit 1
          fi

      - name: Download CLI archives from release workflow
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"

          WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[] | select(.name == "Release") | .id')
          RUN_ID=$(gh api "repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs" \
            --jq ".workflow_runs[] | select(.head_sha == \"$(git rev-parse $TAG_NAME)\") | select(.status == \"completed\") | .id" | head -1)

          echo "Found release workflow run ID: $RUN_ID"

          mkdir -p cli-archives

          gh run download "$RUN_ID" --pattern "cli-archive-*" --dir cli-archives-temp/

          find cli-archives-temp -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | while read file; do
            cp "$file" cli-archives/
          done

          echo "Downloaded CLI archives:"
          ls -la cli-archives/

      - name: Upload CLI archives to GitHub Release
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"

          for file in cli-archives/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              echo "Uploading: $filename"
              gh release upload "$TAG_NAME" "$file" --clobber
              echo "Uploaded: $filename"
            fi
          done

          echo "All CLI binaries uploaded to release: $TAG_NAME"
